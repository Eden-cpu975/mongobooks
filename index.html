<!DOCTYPE html>
<html lang="he">
<head>
  <meta charset="UTF-8">
  <title>× ×™×”×•×œ ×¡×¤×¨×™×</title>
  <style>
    body {
      direction: rtl;
      font-family: Arial;
      padding: 20px;
      background-color: #f5f5f5;
    }
    h1, h2 {
      color: #333;
    }
    ul {
      list-style-type: none;
      padding: 0;
    }
    li {
      padding: 6px;
      background: #fff;
      margin-bottom: 5px;
      border-radius: 5px;
      box-shadow: 0 0 3px rgba(0,0,0,_zero.1);
    }
    input, button {
      margin: 5px 0;
      padding: 8px;
      border-radius: 5px;
      border: 1px solid #ccc;
    }
    button {
      background-color: #4CAF50;
      color: white;
      cursor: pointer;
    }
    button:hover {
      background-color: #45a049;
    }
    .error {
      color: red;
    }
  </style>
</head>
<body>
  <h1>ğŸ“š ×¨×©×™××ª ×¡×¤×¨×™×</h1>
  <div id="error" class="error"></div>
  <p id="bookCount">××¡×¤×¨ ×¡×¤×¨×™×: ×˜×•×¢×Ÿ...</p>
  <ul id="bookList"></ul>

  <h2>×”×•×¡×¤×ª ×¡×¤×¨ ×—×“×©</h2>
  <form id="addBookForm">
    <input type="text" id="title" placeholder="×›×•×ª×¨×ª" required><br>
    <input type="text" id="author" placeholder="××—×‘×¨" required><br>
    <input type="number" id="price" placeholder="××—×™×¨" step="0.01" required><br>
    <button type="submit">×”×•×¡×£</button>
  </form>

  <div id="editForm" class="edit-form">
    <input type="text" id="editTitle" placeholder="×›×•×ª×¨×ª ×—×“×©×”"><br>
    <input type="text" id="editAuthor" placeholder="××—×‘×¨ ×—×“×©"><br>
    <input type="number" id="editPrice" placeholder="××—×™×¨ ×—×“×©" step="0.01"><br>
    <button onclick="saveEdit()">×©××•×¨</button>
    <button onclick="cancelEdit()">×‘×˜×œ</button>
  </div>

  <script>
    const list = document.getElementById('bookList');
    const form = document.getElementById('addBookForm');
    const errorDiv = document.getElementById('error');
    const bookCountDiv = document.getElementById('bookCount');
    const editForm = document.getElementById('editForm');

    // ×”×¦×’×ª ×”×•×“×¢×•×ª ×©×’×™××”
    function showError(message) {
      errorDiv.textContent = message;
      setTimeout(() => errorDiv.textContent = '', 5000);
    }

  // ×©×œ×™×¤×ª ×¡×¤×¨×™× ×•×¡×¤×™×¨×”
    async function fetchBooksAndCount() {
      try {
        const [booksRes, countRes] = await Promise.all([
          fetch('http://localhost:3000/bookss'),
          fetch('http://localhost:3000/bookss/count')
        ]);
        if (!booksRes.ok) throw new Error(`×©×’×™××ª ×©×¨×ª ×¡×¤×¨×™×: ${booksRes.status} - ${await booksRes.text()}`);
        if (!countRes.ok) throw new Error(`×©×’×™××ª ×¡×¤×™×¨×”: ${countRes.status} - ${await countRes.text()}`);
        
        const books = await booksRes.json();
        const count = await countRes.json();
        list.innerHTML = '';
        if (books.length === 0) {
          list.innerHTML = '<li>×œ× × ××¦××• ×¡×¤×¨×™×</li>';
        } else {
          books.forEach(book => {
            const li = document.createElement('li');
            li.innerHTML = `${book.title} - ${book.author} (â‚ª${book.price || '×œ× ×–××™×Ÿ'}) <a href="#" onclick="showEditForm('${book._id}', '${book.title}', '${book.author}', ${book.price || 0})">×¢×¨×•×š</a> <a href="#" onclick="deleteBook('${book._id}')">××—×§</a>`;
            list.appendChild(li);
          });
        }
        bookCountDiv.textContent = `××¡×¤×¨ ×¡×¤×¨×™×: ${count.count}`;
      } catch (err) {
        showError(`×©×’×™××” ×‘×˜×¢×™× ×”: ${err.message}`);
        console.error(err);
        bookCountDiv.textContent = '××¡×¤×¨ ×¡×¤×¨×™×: ×©×’×™××”';
      }
    }

    // ×¤×•× ×§×¦×™×” ×—×“×©×” ×œ××—×™×§×”
async function deleteBook(id) {
  if (!id || typeof id !== 'string' || id.length !== 24) {
    showError('×©×’×™××”: ××–×”×” ×¡×¤×¨ ×œ× ×ª×§×™×Ÿ');
    return;
  }
  if (confirm('×”×× ××ª ×‘×˜×•×—×” ×©×‘×¨×¦×•× ×š ×œ××—×•×§ ××ª ×”×¡×¤×¨?')) {
    try {
      const res = await fetch(`http://localhost:3000/bookss/${id}`, {
        method: 'DELETE'
      });
      if (!res.ok) {
        const errData = await res.json();
        throw new Error(errData.error || '×©×’×™××” ×‘××—×™×§×”');
      }
      showError('×¡×¤×¨ × ××—×§ ×‘×”×¦×œ×—×”!');
      fetchBooksAndCount();
    } catch (err) {
      showError(`×©×’×™××” ×‘××—×™×§×”: ${err.message}`);
      console.error(err);
    }
  }
}
    // ×”×•×¡×¤×ª ×¡×¤×¨
    form.addEventListener('submit', async function(e) {
      e.preventDefault();
      const title = document.getElementById('title').value;
      const author = document.getElementById('author').value;
      const price = parseFloat(document.getElementById('price').value);

      if (!title || !author || isNaN(price)) {
        showError('×× × ××œ× ××ª ×›×œ ×”×©×“×•×ª ×‘×¦×•×¨×” ×ª×§×™× ×”');
        return;
      }

      try {
        const res = await fetch('http://localhost:3000/bookss', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ title, author, price })
        });
        if (!res.ok) {
          const errData = await res.json();
          throw new Error(errData.err || '×©×’×™××” ×‘×”×•×¡×¤×ª ×”×¡×¤×¨');
        }
        form.reset();
        showError('×¡×¤×¨ × ×•×¡×£ ×‘×”×¦×œ×—×”!');
        fetchBooksAndCount(); // ×¢×“×›×•×Ÿ ×¡×¤×¨×™× ×•×¡×¤×™×¨×”
      } catch (err) {
        showError(`×©×’×™××” ×‘×”×•×¡×¤×ª ×”×¡×¤×¨: ${err.message}`);
        console.error(err);
      }
    });

    // ×”×¦×’×ª ×˜×•×¤×¡ ×¢×¨×™×›×”
    function showEditForm(id, title, author, price) {
      if (!id || typeof id !== 'string' || id.length !== 24) {
        showError('×©×’×™××”: ××–×”×” ×¡×¤×¨ ×œ× ×ª×§×™×Ÿ. ×‘×“×•×§ ×‘-Console.');
        console.log('Invalid ID:', id); // ×œ×•×’ ×œ×‘×“×™×§×”
        return;
      }
      document.getElementById('editTitle').value = title;
      document.getElementById('editAuthor').value = author;
      document.getElementById('editPrice').value = price;
      editForm.style.display = 'block';
      window.currentEditId = id; // ×©××™×¨×ª ×”-ID ×œ×¢×“×›×•×Ÿ
    }

    // ×©××™×¨×ª ×¢×“×›×•×Ÿ
    async function saveEdit() {
      const updatedBook = {
        title: document.getElementById('editTitle').value,
        author: document.getElementById('editAuthor').value,
        price: parseFloat(document.getElementById('editPrice').value)
      };

      if (!window.currentEditId || typeof window.currentEditId !== 'string' || window.currentEditId.length !== 24) {
        showError('×©×’×™××”: ××–×”×” ×¡×¤×¨ ×œ× ×ª×§×™×Ÿ');
        console.log('Invalid currentEditId:', window.currentEditId);
        return;
      }

      try {
        const res = await fetch(`http://localhost:3000/bookss/${window.currentEditId}`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(updatedBook)
        });
        if (!res.ok) {
          const errData = await res.json();
          throw new Error(errData.error || '×©×’×™××” ×‘×¢×“×›×•×Ÿ');
        }
        showError('×¡×¤×¨ ×¢×•×“×›×Ÿ ×‘×”×¦×œ×—×”!');
        cancelEdit();
        fetchBooksAndCount();
      } catch (err) {
        showError(`×©×’×™××” ×‘×¢×“×›×•×Ÿ: ${err.message}`);
        console.error(err);
      }
    }

    // ×‘×™×˜×•×œ ×¢×¨×™×›×”
    function cancelEdit() {
      editForm.style.display = 'none';
      document.getElementById('editTitle').value = '';
      document.getElementById('editAuthor').value = '';
      document.getElementById('editPrice').value = '';
      delete window.currentEditId;
    }

    // ×©×œ×™×¤×ª ×¡×¤×¨×™× ×•×¡×¤×™×¨×” ×‘×”×ª×—×œ×”
    fetchBooksAndCount();
  </script>
</body>
</html>

